/*!
 *version:2.0.0,
 *author:hezedu,
 *Released: mit,
 *Date:2015-7-6
 *repository:https://github.com/hezedu/sas
 *home:https://github.com/hezedu/sas*/
function sas(s,t,e){var a;if("object"!=typeof t)switch(arguments.length){case 2:e=t;break;case 3:a=t;break;default:t={}}else a=t.iterator,e=e||t.allEnd;new sas.min(s,a,e,t)}sas.type=Object.prototype.toString,sas.ARR="[object Array]",sas.FN="[object Function]",sas.OBJ="[object Object]",sas.copy=function(s){var t;switch(sas.type.call(s)){case sas.OBJ:t={};for(var e in s)sas._copy(s,e,t);break;case sas.ARR:t=[],len=s.length;for(var e=0;e<len;e++)sas._copy(s,e,t);break;default:t=s}return t},sas._copy=function(s,t,e){switch(sas.type.call(s[t])){case sas.OBJ:e[t]={};for(var a in s[t])sas._copy(s[t],a,e[t]);break;case sas.ARR:e[t]=[],len=s[t].length;for(var a=0;a<len;a++)sas._copy(s[t],a,e[t]);break;default:e[t]=s[t]}},sas.min=function(s,t,e,a){this.tasks_count=0,this.tasks_count_cb=0,this.STOP=!1,this.error=null,this.end=e,this.ite=t,this.process=a.process,this.process_interval=a.process_interval||1e3,this.plan=a.copy?sas.copy(s):s,this.init()},sas.min.prototype.init=function(){switch(sas.type.call(this.plan)){case sas.OBJ:for(var s=Object.keys(this.plan),t=s.length,e=[t,0],a=0;t>a;a++)this.dis(s[a],this.plan,e);break;case sas.ARR:var e=[this.plan.length,0];this.dis(e[1],this.plan,e);break;default:return}},sas.min.prototype.dis=function(s,t,e,a){if(!this.STOP)switch(sas.type.call(t[s])){case sas.FN:this.forFn(s,t,e,a);break;case sas.OBJ:for(var n=Object.keys(t[s]),i=n.length,r=[i,0],o=0;i>o;o++)this.dis(n[o],t[s],r,arguments);break;case sas.ARR:var r=[t[s].length,0];this.dis(r[1],t[s],r,arguments);break;default:this.ite?(t[s]=this.ite(t[s]),this.forFn(s,t,e,a)):(e[1]++,this.next_tick(s,t,e,a))}},sas.min.prototype.forFn=function(s,t,e,a){function n(n,i){if(r.tasks_count_cb++,!r.STOP)switch(n){case"$STOP":return r.end&&r.end(i),r.STOP=!0;case"$THIS=":a&&(a[1][a[0]]=i),e[1]=e[0];break;case"$END":e[1]=e[0];break;case"$HOLD":e[1]++;break;case"$RELOAD":t[s]=i||t[s],r.dis(s,t,e,a);break;default:if(e[1]++,arguments.length<2)t[s]=n;else{for(var o=[],c=0,h=arguments.length;h>c;c++)o.push(arguments[c]);t[s]=o}r.next_tick(s,t,e,a)}}this.tasks_count++;var i=null;t[s].length>1&&(i=new sas.Index(s,t,e,a,this)),t[s](n,i);var r=this},sas.min.prototype.next_tick=function(s,t,e,a){e[0]===e[1]?a?(a[2][1]++,this.next_tick.apply(this,a)):this.end&&this.end(null,this.plan):"number"==typeof s&&this.dis(e[1],t,e,a)},sas.min.prototype._process=function(){this.process&&(this._t=setInterval(function(){this.process(this.tasks_count,this.tasks_count_cb)},this.process_interval))},sas.min.prototype._end=function(){this.process&&(clearInterval(this._t),this.process(this.tasks_count,this.tasks_count_cb),this.end&&this.end(this.error,this.plan))},sas.Index=function(s,t,e,a,n){this.index=s,this.path=[s],this.count=e,this.dis=n;var i,r=0,o=!1;if(a)for(i=a,this.parent=a[1],this.pIndex=a[0];i;)r++,o||"number"!=typeof i[0]||(this.Sparent=i[1],this.SpIndex=i[0],o=!0),this.path.splice(0,0,i[0]),i=i[3]},sas.Index.prototype.fspath=function(){for(var s=[],t=this.path,e=0,a=t.length;a>e;e++)"string"==typeof t[e]&&s.push(t[e]);return s},sas.Index.prototype.push=function(s){this.count[0]++,this.parent?this.parent[this.pIndex].push(s):this.dis.plan.push(s)},"object"==typeof module&&"object"==typeof module.exports&&(module.exports=sas);