/*!
 *version:2.0.5  Released: jQuery.Release 
 *repository:https://github.com/hezedu/sas
 *by hezedu 2015/7/26
*/

function sas(s,t,e){var n;if("object"!=typeof t)switch(arguments.length){case 2:e=t;break;case 3:n=t;break;default:t={}}else n=t.iterator,e=e||t.allEnd;new sas.min(s,n,e,t)}sas.type=Object.prototype.toString,sas.ARR="[object Array]",sas.FN="[object Function]",sas.OBJ="[object Object]",sas.copy=function(s){var t=[];return sas._copy([s],0,t),t[0]},sas._copy=function(s,t,e){switch(sas.type.call(s[t])){case sas.OBJ:e[t]={};for(var n in s[t])sas._copy(s[t],n,e[t]);break;case sas.ARR:e[t]=[],len=s[t].length;for(var n=0;n<len;n++)sas._copy(s[t],n,e[t]);break;default:e[t]=s[t]}},sas.min=function(s,t,e,n){this.tasks_count=0,this.tasks_count_cb=0,this.STOP=!1,this.error=null,this.end=e,this.ite=t,this.process=n.process,this.process_interval=n.process_interval||1e3,this.plan=n.copy?sas.copy(s):s,this.init()},sas.min.prototype.init=function(){var s=[1,0];this.dis(s[1],[this.plan],s)},sas.min.prototype.dis=function(s,t,e,n){if(!this.STOP)switch(sas.type.call(t[s])){case sas.FN:this.forFn(s,t,e,n);break;case sas.OBJ:for(var i=Object.keys(t[s]),a=i.length,r=[a,0],o=0;a>o;o++)this.dis(i[o],t[s],r,arguments);break;case sas.ARR:var r=[t[s].length,0];this.dis(r[1],t[s],r,arguments);break;default:this.ite?(t[s]=this.ite(t[s]),this.forFn(s,t,e,n)):(e[1]++,this.next_tick(s,t,e,n))}},sas.min.prototype.forFn=function(s,t,e,n){function i(i,a){if(r.tasks_count_cb++,!r.STOP){switch(i){case"$STOP":return r.error=a||new Error("sas $STOP"),r._end(),r.STOP=!0;case"$THIS=":n[1][n[0]]=a,e[1]=e[0];break;case"$END":e[1]=e[0];break;case"$HOLD":e[1]++;break;case"$RELOAD":return t[s]=a||t[s],r.dis(s,t,e,n);default:if(e[1]++,arguments.length<2)t[s]=i;else{for(var o=[],c=0,h=arguments.length;h>c;c++)o.push(arguments[c]);t[s]=o}}r.next_tick(s,t,e,n)}}this.tasks_count++;var a=null,r=this;t[s].length>1&&(a=new sas.Index(s,t,e,n)),t[s](i,a)},sas.min.prototype.next_tick=function(s,t,e,n){e[0]===e[1]?n?(n[2][1]++,this.next_tick.apply(this,n)):this._end():"number"==typeof s&&this.dis(e[1],t,e,n)},sas.min.prototype._process=function(){this.process&&(this._t=setInterval(function(){this.process(this.tasks_count,this.tasks_count_cb)},this.process_interval))},sas.min.prototype._end=function(){this.process&&(clearInterval(this._t),this.process(this.tasks_count,this.tasks_count_cb)),this.end&&this.end(this.error,this.plan)},sas.Index=function(s,t,e,n){this.index=s,this.path=[s],this.count=e;var i,a=0,r=!1;for(i=n,this.parent=n[1],this.pIndex=n[0];i[3];)a++,r||"number"!=typeof i[0]||(this.Sparent=i[1],this.SpIndex=i[0],r=!0),this.path.splice(0,0,i[0]),i=i[3]},sas.Index.prototype.fspath=function(){for(var s=[],t=this.path,e=0,n=t.length;n>e;e++)"string"==typeof t[e]&&s.push(t[e]);return s},sas.Index.prototype.push=function(s){this.count[0]++,this.parent[this.pIndex].push(s)},"object"==typeof module&&"object"==typeof module.exports&&(module.exports=sas);