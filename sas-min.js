/*!
 *version:2.0.6  Released: jQuery.Release 
 *repository:https://github.com/hezedu/sas
 *by hezedu 2015/7/26
*/

function sas(s,t,e){var i;if("object"!=typeof t)switch(arguments.length){case 2:e=t;break;case 3:i=t;break;default:t={}}else i=t.iterator,e=e||t.allEnd;new sas.min(s,i,e,t)}sas.type=Object.prototype.toString,sas.ARR="[object Array]",sas.FN="[object Function]",sas.OBJ="[object Object]",sas.copy=function(s){var t=[];return sas._copy([s],0,t),t[0]},sas._copy=function(s,t,e){switch(sas.type.call(s[t])){case sas.OBJ:e[t]={};for(var i in s[t])sas._copy(s[t],i,e[t]);break;case sas.ARR:e[t]=[],len=s[t].length;for(var i=0;i<len;i++)sas._copy(s[t],i,e[t]);break;default:e[t]=s[t]}},sas.min=function(s,t,e,i){this.tasks_count=0,this.tasks_count_cb=0,this.STOP=!1,this.error=null,this.end=e,this.ite=t,this.process=i.process,this.process_interval=i.process_interval||1e3,this.plan=i.copy?sas.copy(s):s,this.init()},sas.min.prototype.init=function(){var s=[1,0];this.dis(s[1],[this.plan],s)},sas.min.prototype.dis=function(s,t,e,i){if(!this.STOP)switch(sas.type.call(t[s])){case sas.FN:this.forFn(s,t,e,i);break;case sas.OBJ:for(var n=Object.keys(t[s]),a=n.length,o=[a,0],r=0;a>r;r++)this.dis(n[r],t[s],o,arguments);break;case sas.ARR:var o=[t[s].length,0];this.dis(o[1],t[s],o,arguments);break;default:this.ite?(t[s]=this.ite(t[s]),this.forFn(s,t,e,i)):(e[1]++,this.next_tick(s,t,e,i))}},sas.min.prototype.forFn=function(s,t,e,i){function n(n,a){if(o.tasks_count_cb++,!o.STOP){switch(n){case"$STOP":return o.error=a||new Error("sas $STOP"),o._end(),o.STOP=!0;case"$THIS=":i[1][i[0]]=a,e[1]=e[0];break;case"$END":e[1]=e[0];break;case"$HOLD":e[1]++;break;case"$RELOAD":return t[s]=a||t[s],o.dis(s,t,e,i);default:e[1]++,t[s]=n}o.next_tick(s,t,e,i)}}this.tasks_count++;var a=null,o=this;t[s].length>1&&(a=new sas.Index(s,t,e,i)),t[s](n,a)},sas.min.prototype.next_tick=function(s,t,e,i){e[0]===e[1]?i?(i[2][1]++,this.next_tick.apply(this,i)):this._end():"number"==typeof s&&this.dis(e[1],t,e,i)},sas.min.prototype._process=function(){this.process&&(this._t=setInterval(function(){this.process(this.tasks_count,this.tasks_count_cb)},this.process_interval))},sas.min.prototype._end=function(){this.process&&(clearInterval(this._t),this.process(this.tasks_count,this.tasks_count_cb)),this.end&&this.end(this.error,this.plan)},sas.Index=function(s,t,e,i){this.index=s,this.path=[s],this.count=e;var n,a=0,o=!1;for(n=i,this.parent=i[1],this.pIndex=i[0];n[3];)a++,o||"number"!=typeof n[0]||(this.Sparent=n[1],this.SpIndex=n[0],o=!0),this.path.splice(0,0,n[0]),n=n[3]},sas.Index.prototype.fspath=function(){for(var s=[],t=this.path,e=0,i=t.length;i>e;e++)"string"==typeof t[e]&&s.push(t[e]);return s},sas.Index.prototype.push=function(s){this.count[0]++,this.parent[this.pIndex].push(s)},"object"==typeof module&&"object"==typeof module.exports&&(module.exports=sas);